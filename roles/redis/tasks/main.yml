- name: Extract redis into {{ apps_base_dir }}
  unarchive:
    src: down/redis-5.0.5.tar.gz
    dest: "/tmp"

- name: install gcc automake autoconf libtool make
  yum:
    name: "{{ packages }}"
  vars:
    packages:
    - gcc
    - automake
    - autoconf
    - libtool
    - make

- name: prepare redis dir
  file: name={{ item }} state=directory
  with_items:
  - "{{ apps_base_dir }}/redis"
  - "{{ apps_base_dir }}/redis/conf"
  

- name: compile and install redis
  shell: "make && make PREFIX={{ apps_base_dir }}/redis install"
  args:
    chdir: "/tmp/redis-5.0.5"


- name: update $PATH veriable for redis.
  lineinfile:
    dest: /etc/profile
    state: present
    regexp: 'ansible_java_path'
    line: 'export PATH={{ apps_base_dir }}/redis/bin:$PATH  # generated by ansible_redis_path'


- name: enable redis variable
  shell: "source /etc/profile"

- name: set redis config
  template:
    src: redis.conf.j2
    dest: "{{ apps_base_dir }}/redis/conf/6379.conf"

- name: set power on script.
  template:
    src: redis.j2
    dest: "/etc/init.d/redis"

- name: set power on redis.
  shell: "chmod +x /etc/init.d/redis &&  chkconfig redis on && service redis start"



