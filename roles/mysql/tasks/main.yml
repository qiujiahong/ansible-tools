- name: remove old mysql data file.
  file: name={{ item }} state=absent
  with_items:
  - "{{ data_base_dir }}/mysql"

- name: prepare some dirs for mysql
  file: name={{ item }} state=directory
  with_items:
  - "/usr/local/mysql/"
  - "{{ data_base_dir }}/mysql"
  - "{{ logs_base_dir }}/mysql"

# - name: Extract nginx into {{ apps_base_dir }}
#   unarchive:
#     src: down/mysql-5.7.26-el7-x86_64.tar.gz
#     dest: "/tmp"

# - name: movie mysql install file.
#   shell: "mv /tmp/mysql-5.7.26-el7-x86_64/* /usr/local/mysql/"

# - name: add mysql user and mysql group.
#   shell: "groupadd mysql && useradd -r -g mysql mysql"

- name: install libaio
  yum:
    name: "{{ packages }}"
  vars:
    packages:
    - libaio


- name: set mysql config  script.
  template:
    src: my.cnf
    dest: "/etc/my.cnf"


- name: ./bin/mysqld --initialize --user=mysql --datadir=/apps/data/mysql/.
  shell: "./bin/mysqld --initialize --user=mysql --datadir=/apps/data/mysql/"
  args:
    chdir: "/usr/local/mysql/"

- name: ./bin/mysql_ssl_rsa_setup.
  shell: "./bin/mysql_ssl_rsa_setup"
  args:
    chdir: "/usr/local/mysql/"


- name: set mysql start script.
  template:
    src: mysql.server
    dest: "/etc/init.d/mysql"

- name: update $PATH veriable for java.
  lineinfile:
    dest: /etc/profile
    state: present
    regexp: 'ansible_java_path'
    line: 'export PATH=/usr/local/mysql/bin/:$PATH  # generated by ansible_mysql_path'

- name: set power on mysql.
  shell: "source /etc/profile && chmod +x /etc/init.d/mysql &&  chkconfig mysql on && service mysql start"



# update user set authentication_string = password("123456") where user="root" ;
# SET PASSWORD = PASSWORD('123456');
# ALTER USER 'root'@'localhost' PASSWORD EXPIRE NEVER;
# flush privileges;
# mysql -uroot -p123456 -Dmysql -e"select 1"  

